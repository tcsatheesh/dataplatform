{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "resources": {
            "value": [
                {
                    "type": "salesforce",
                    "datafactoryResourceGroup": {
                        "name": "",
                        "ref": {
                            "resourceType": "resourcegroups",
                            "type": "app",
                            "property": "name"
                        }
                    },
                    "dataFactory": {
                        "name": "",
                        "ref": {
                            "resourceType": "adfs",
                            "type": "adf",
                            "property": "name"
                        }
                    },
                    "resources": {
                        "linkedservices": [
                            {
                                "name": "Salesforce",
                                "type": "salesforce",
                                "templateFile": "salesforce\\linkedservice.json",
                                "parameters": [
                                    {
                                        "type": "usernameSecretName",
                                        "ref": {
                                            "resourceType": "keyvaultsecrets",
                                            "typeFilter": "value",
                                            "subtypeFilter": "salesforce.com.username",
                                            "property": "name"
                                        }
                                    },
                                    {
                                        "type": "passwordSecretName",
                                        "ref": {
                                            "resourceType": "keyvaultsecrets",
                                            "typeFilter": "value",
                                            "subtypeFilter": "salesforce.com.password",
                                            "property": "name"
                                        }
                                    },
                                    {
                                        "type": "securityTokenSecretName",
                                        "ref": {
                                            "resourceType": "keyvaultsecrets",
                                            "typeFilter": "value",
                                            "subtypeFilter": "salesforce.com.securitytoken",
                                            "property": "name"
                                        }
                                    },
                                    {
                                        "type": "keyvault",
                                        "ref": {
                                            "resourceType": "keyvaults",
                                            "typeFilter": "appkeyvault",
                                            "property": "name"
                                        }
                                    }
                                ]
                            }
                        ],
                        "inputdatasets": [
                            {
                                "name": "SalesforceDataset",
                                "type": "salesforce",
                                "templateFile": "salesforce\\input1.json",
                                "parameters": [
                                    {
                                        "type": "referenceName",
                                        "value": "Salesforce"
                                    }
                                ]
                            },
                            {
                                "name": "ADLSLookupDataset",
                                "type": "foreach",
                                "templateFile": "salesforce\\input2.json",
                                "parameters": [
                                    {
                                        "type": "referenceName",
                                        "ref": {
                                            "resourceType": "adlstores",
                                            "typeFilter": "adlstore",
                                            "property": "name"
                                        }
                                    }
                                ]
                            }
                        ],
                        "outputdatasets": [
                            {
                                "name": "ADLSDataSetSF",
                                "type": "salesforce",
                                "templateFile": "salesforce\\output.json",
                                "parameters": [
                                    {
                                        "type": "referenceName",
                                        "ref": {
                                            "resourceType": "adlstores",
                                            "typeFilter": "adlstore",
                                            "property": "name"
                                        }
                                    }
                                ]
                            }
                        ],
                        "pipelines": [
                            {
                                "name": "SalesforcePipeline",
                                "type": "salesforce",
                                "templateFile": "salesforce\\pipeline1.json",
                                "parameters": [
                                    {
                                        "type": "inputdataset",
                                        "value": "SalesforceDataset"
                                    },
                                    {
                                        "type": "outputdataset",
                                        "value": "ADLSDataSetSF"
                                    },
                                    {
                                        "type": "dffolderName",
                                        "value": "Salesforce"
                                    }
                                ]
                            },
                            {
                                "name": "SalesforcePipeline-ForEach",
                                "type": "foreach",
                                "templateFile": "salesforce\\pipeline2.json",
                                "parameters": [
                                    {
                                        "type": "referenceName",
                                        "value": "ADLSLookupDataset"
                                    },
                                    {
                                        "type": "dffolderName",
                                        "value": "Salesforce"
                                    }
                                ]
                            }                            
                        ],
                        "triggers": [
                            {
                                "name": "SalesForceTrigger-ForEach",
                                "type": "foreach",
                                "templateFile": "salesforce\\trigger.json",
                                "parameters": [
                                    {
                                        "type": "startTime",
                                        "value": "2018-07-02T16:00:00Z"
                                    },
                                    {
                                        "type": "interval",
                                        "value": "1"
                                    },
                                    {
                                        "type": "outputFolderPath",
                                        "value": "@concat('raw/', formatDateTime(trigger().outputs.windowStartTime,'yyyy'), '/', formatDateTime(trigger().outputs.windowStartTime,'MM'), '/', formatDateTime(trigger().outputs.windowStartTime,'dd'), '/', formatDateTime(trigger().outputs.windowStartTime,'HH'), '/', formatDateTime(trigger().outputs.windowStartTime,'mm'), '/')"
                                    },
                                    {
                                        "type": "pipelineName",
                                        "value": "SalesforcePipeline-ForEach"
                                    },
                                    {
                                        "type": "inputFolderPath",
                                        "value": "/stage/lookup/"
                                    },
                                    {
                                        "type": "inputFileName",
                                        "value": "dimtables.json"
                                    }
                                ]
                            }
                        ]
                    }
                },
                {
                    "type": "pattern1",
                    "resourceType": "dfpipelines",
                    "resourceGroupTypeRef": "app",
                    "name" : "{0}{1}{2}adfv201",
                    "location": "northeurope",
                    "templateFileName": "pattern1.json",
                    "parameterFileName": "pattern1.parameters.json",
                    "parameters" : [
                        {
                            "name": "sourceDataSetName",
                            "type": "format",
                            "value": "{0}{1}{2}_src_ds"
                        },
                        {
                            "name": "destinationDatasetName",
                            "type": "format",
                            "value": "{0}{1}{2}_dest_ds"
                        },
                        {
                            "name": "sourceLinkedServiceName",
                            "type": "format",
                            "value": "{0}{1}{2}nestgdia"
                        },
                        {
                            "name": "destinationLinkedServiceName",
                            "type": "format",
                            "value": "{0}{1}{2}nestgdia"
                        },
                        {
                            "name": "pipelineName",
                            "type": "format",
                            "value": "{0}{1}{2}_pipeline_outer"
                        },
                        {
                            "name": "folderName",
                            "type": "format",
                            "value": "{0}{1}{2}_pattern_1"
                        },
                        {
                            "name": "copyActivityName",
                            "type": "format",
                            "value": "{0}{1}{2}_copy_activity"
                        },
                        {
                            "name": "ifconditionCopyActivityName",
                            "type": "format",
                            "value": "IfCopyHasWrittenFiles"
                        },
                        {
                            "name": "copyCondition",
                            "type": "format",
                            "value": "@greater(activity('{0}{1}{2}_copy_activity').output.filesWritten,0)"
                        },
                        {
                            "name": "innerPipelineName1",
                            "type": "format",
                            "value": "{0}{1}{2}_pipeline_inner_1"
                        },
                        {
                            "name": "metaDataActivityName",
                            "type": "format",
                            "value": "{0}{1}{2}_metadata_activity_1"
                        },
                        {
                            "name": "forEachActivityName",
                            "type": "format",
                            "value": "{0}{1}{2}_foreach_activity_1"
                        },
                        {
                            "name": "forEachOutputIter",
                            "type": "format",
                            "value": "@activity('{0}{1}{2}_metadata_activity_1').output.childItems"
                        },
                        {
                            "name": "metaDataActivityName2",
                            "type": "format",
                            "value": "{0}{1}{2}_metadata_activity_2"
                        },
                        {
                            "name": "forEachActivityName2",
                            "type": "format",
                            "value": "{0}{1}{2}_foreach_activity_2"
                        },
                        {
                            "name": "forEachOutputIter2",
                            "type": "format",
                            "value": "@activity('{0}{1}{2}_metadata_activity_2').output.childItems"
                        },
                        {
                            "name": "innerPipelineName2",
                            "type": "format",
                            "value": "{0}{1}{2}_pipeline_inner_2"
                        },
                        {
                            "name": "functionActivityName",
                            "type": "format",
                            "value": "{0}{1}{2}_function_activity"
                        },
                        {
                            "name" : "ifconditionControlFileActivityName",
                            "type": "value",
                            "value": "IfControlFile"
                        },
                        {
                            "name": "functionName",
                            "type": "value",
                            "value": "TransformXMLToJSON"
                        },
                        {
                            "name": "functionLinkedServiceName",
                            "type": "format",
                            "value": "{0}{1}{2}fn01"
                        },
                        {
                            "name": "triggerName",
                            "type": "format",
                            "value": "{0}{1}{2}trigger"
                        },
                        {
                            "name": "triggerStartTime",
                            "type": "utcdatetime",
                            "value": "-1",
                            "format": "yyyy-MM-ddTHH:00:00Z"
                        },
                        {
                            "name": "inputFileName",
                            "type": "value",
                            "value": "@concat('*_',formatDateTime(dataset().windowStartTime,'yyyyMMddHH'),'*.zip')"
                        },
                        {
                            "name": "inputFolderName",
                            "type": "value",
                            "value": "source"
                        },
                        {
                            "name": "destinationFolderPath",
                            "type": "value",
                            "value": "@concat('destination/',formatDateTime(pipeline().parameters.windowStartTime,'yyyyMMddHH'),'/')"
                        },
                        {
                            "name": "controlFileCondition",
                            "type": "value",
                            "value": "@endswith(item().name,'pmc.xml')"
                        },
                        {
                            "name": "metadataactivity2_folderPath",
                            "type": "value",
                            "value": "@concat('destination/',formatDateTime(pipeline().parameters.windowStartTime,'yyyyMMddHH'),'/',pipeline().parameters.item.name)"
                        },
                        {
                            "name": "functionAppParameter",
                            "type": "value",
                            "value": "@concat('destination/',formatDateTime(pipeline().parameters.windowStartTime,'yyyyMMddHH'),'/',pipeline().parameters.item.name,'/',item().name)"
                        }
                    ]
                }
            ]
        }
    }
}