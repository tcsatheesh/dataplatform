{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "resources": {
            "value": [
                {
                    "type": "salesforce",
                    "datafactoryResourceGroup": {
                        "name": "",
                        "ref": {
                            "resourceType": "resourcegroups",
                            "type": "app",
                            "property": "name"
                        }
                    },
                    "dataFactory": {
                        "name": "",
                        "ref": {
                            "resourceType": "adfs",
                            "type": "adf",
                            "property": "name"
                        }
                    },
                    "resources": {
                        "linkedservices": [
                            {
                                "name": "Salesforce",
                                "type": "salesforce",
                                "templateFile": "salesforce\\linkedservice.json",
                                "parameters": [
                                    {
                                        "type": "usernameSecretName",
                                        "ref": {
                                            "resourceType": "keyvaultsecrets",
                                            "typeFilter": "value",
                                            "subtypeFilter": "salesforce.com.username",
                                            "property": "name"
                                        }
                                    },
                                    {
                                        "type": "passwordSecretName",
                                        "ref": {
                                            "resourceType": "keyvaultsecrets",
                                            "typeFilter": "value",
                                            "subtypeFilter": "salesforce.com.password",
                                            "property": "name"
                                        }
                                    },
                                    {
                                        "type": "securityTokenSecretName",
                                        "ref": {
                                            "resourceType": "keyvaultsecrets",
                                            "typeFilter": "value",
                                            "subtypeFilter": "salesforce.com.securitytoken",
                                            "property": "name"
                                        }
                                    },
                                    {
                                        "type": "keyvault",
                                        "ref": {
                                            "resourceType": "keyvaults",
                                            "typeFilter": "appkeyvault",
                                            "property": "name"
                                        }
                                    }
                                ]
                            }
                        ],
                        "inputdatasets": [
                            {
                                "name": "SalesforceDataset",
                                "type": "salesforce",
                                "templateFile": "salesforce\\input.json",
                                "parameters": [
                                    {
                                        "type": "referenceName",
                                        "value": "Salesforce"
                                    }
                                ]
                            }
                        ],
                        "outputdatasets": [
                            {
                                "name": "ADLSDataSetSF",
                                "type": "salesforce",
                                "templateFile": "salesforce\\output.json",
                                "parameters": [
                                    {
                                        "type": "referenceName",
                                        "ref": {
                                            "resourceType": "adlstores",
                                            "typeFilter": "adlstore",
                                            "property": "name"
                                        }
                                    }
                                ]
                            }
                        ],
                        "pipelines": [
                            {
                                "name": "SalesforcePipeline",
                                "type": "salesforce",
                                "templateFile": "salesforce\\pipeline.json",
                                "parameters": [
                                    {
                                        "type": "inputdataset",
                                        "value": "SalesforceDataset"
                                    },
                                    {
                                        "type": "outputdataset",
                                        "value": "ADLSDataSetSF"
                                    }
                                ]
                            }
                        ],
                        "triggers": [
                            {
                                "name": "SalesForceTrigger",
                                "type": "salesforce",
                                "templateFile": "salesforce\\trigger.json",
                                "parameters": [
                                    {
                                        "type": "startTime",
                                        "value": "2018-07-02T05:00:00Z"
                                    },
                                    {
                                        "type": "pipelineName",
                                        "value": "SalesforcePipeline"
                                    },
                                    {
                                        "type": "outputFolderPath",
                                        "value": "@concat('raw/', formatDateTime(trigger().outputs.windowStartTime,'yyyy'), '/', formatDateTime(trigger().outputs.windowStartTime,'MM'), '/', formatDateTime(trigger().outputs.windowStartTime,'dd'), '/', formatDateTime(trigger().outputs.windowStartTime,'HH'), '/', formatDateTime(trigger().outputs.windowStartTime,'mm'), '/')"
                                    },
                                    {
                                        "type": "outputFilePath",
                                        "value-old": "account.csv",
                                        "value": "contact.csv"
                                    },
                                    {
                                        "type": "query",
                                        "value-old": "SELECT Id, Name, Type, BillingCountry AccountNumber FROM Account",
                                        "value": "SELECT Id, AccountId, FirstName, LastName FROM Contact"
                                    }
                                ]
                            }
                        ]
                    }
                },
                {
                    "type": "foreach",
                    "datafactoryResourceGroup": {
                        "name": "",
                        "ref": {
                            "resourceType": "resourcegroups",
                            "type": "app",
                            "property": "name"
                        }
                    },
                    "dataFactory": {
                        "name": "",
                        "ref": {
                            "resourceType": "adfs",
                            "type": "adf",
                            "property": "name"
                        }
                    },
                    "resources": {
                        "inputdatasets": [
                            {
                                "name": "ADLSLookupDataset",
                                "type": "foreach",
                                "templateFile": "foreach\\input.json",
                                "parameters": [
                                    {
                                        "type": "referenceName",
                                        "ref": {
                                            "resourceType": "adlstores",
                                            "typeFilter": "adlstore",
                                            "property": "name"
                                        }
                                    }
                                ]
                            }
                        ],
                        "pipelines": [
                            {
                                "name": "SalesforcePipeline-ForEach",
                                "type": "foreach",
                                "templateFile": "foreach\\pipeline.json",
                                "parameters": [
                                    {
                                        "type": "referenceName",
                                        "value": "ADLSLookupDataset"
                                    }
                                ]
                            }
                        ],
                        "triggers": [
                            {
                                "name": "SalesForceTrigger-ForEach",
                                "type": "foreach",
                                "templateFile": "foreach\\trigger.json",
                                "parameters": [
                                    {
                                        "type": "startTime",
                                        "value": "2018-07-02T16:00:00Z"
                                    },
                                    {
                                        "type": "interval",
                                        "value": "1"
                                    },
                                    {
                                        "type": "outputFolderPath",
                                        "value": "@concat('raw/', formatDateTime(trigger().outputs.windowStartTime,'yyyy'), '/', formatDateTime(trigger().outputs.windowStartTime,'MM'), '/', formatDateTime(trigger().outputs.windowStartTime,'dd'), '/', formatDateTime(trigger().outputs.windowStartTime,'HH'), '/', formatDateTime(trigger().outputs.windowStartTime,'mm'), '/')"
                                    },
                                    {
                                        "type": "pipelineName",
                                        "value": "SalesforcePipeline-ForEach"
                                    },
                                    {
                                        "type": "inputFolderPath",
                                        "value": "/stage/lookup/"
                                    },
                                    {
                                        "type": "inputFileName",
                                        "value": "sourcetable.json"
                                    }
                                ]
                            }
                        ]
                    }
                }
            ]
        }
    }
}